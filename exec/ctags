#!/bin/bash -e
IDE_PREFIX="ide/ctags"

# This script should only be executed through bin/ide
test -z "$IDE_PATH" && exit 1

# Include common functions
. "$IDE_PATH/lib/functions.sh"


#############################################################################
#############################################################################


if ! CTAGS_CONFIG=$(__ide_config ide.ctags.config)
then
    logerr "You must configure ide.ctags.config"
    exit 1
fi


log "Warming up the ctags cache..."
log "Using ctags options file $CTAGS_CONFIG"


if [[ '--vendors' == "$1" ]]
then

    log "Creating tags in ${GIT_DIR}/tags_vendors"

    if [ -d vendor ]
    then
        log "Symfony2 style project detected"
        find vendor -type f -name '*.php' | \
            ctags -L - --tag-relative --options=${CTAGS_CONFIG} -o ${GIT_DIR}/tags_vendors > /dev/null 2>&1
    elif [ -d env ]
    then
        log "Python style project detected"
        find env/lib/*/site-packages -type f -name '*.py' | \
            ctags -L - --tag-relative --options=${CTAGS_CONFIG} -o ${GIT_DIR}/tags_vendors > /dev/null 2>&1
    else
        logerr "Oops, don't know what kind of project this is..."
        exit 1
    fi

else

    log "Creating tags in ${GIT_DIR}/tags"

    git ls-files | \
        ctags -L - --tag-relative --options=${CTAGS_CONFIG} -o ${GIT_DIR}/tags > /dev/null 2>&1

fi

log "Done."
